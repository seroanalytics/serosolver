<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Adaptive Metropolis-within-Gibbs/Metropolis Hastings Random Walk Algorithm. — serosolver • serosolver</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Adaptive Metropolis-within-Gibbs/Metropolis Hastings Random Walk Algorithm. — serosolver" />
<meta property="og:description" content="The Adaptive Metropolis-within-Gibbs algorithm. Given a starting point and the necessary MCMC parameters as set out below, performs a random-walk of the posterior space to produce an MCMC chain that can be used to generate MCMC density and iteration plots. The algorithm undergoes an adaptive period, where it changes the step size of the random walk for each parameter to approach the desired acceptance rate, popt. The algorithm then uses univ_proposal or mvr_proposal to explore parameter space, recording the value and posterior value at each step. The MCMC chain is saved in blocks as a .csv file at the location given by filename. This version of the algorithm is also designed to explore posterior densities for infection histories. See the package vignettes for examples." />
<meta name="twitter:card" content="summary" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serosolver</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/cs1_vignette.html">Paper case study 1: serosolver</a>
    </li>
    <li>
      <a href="../articles/cs2_vignette.html">Paper case study 2: serosolver</a>
    </li>
    <li>
      <a href="../articles/serosolver-quick_start_guide.html">Quick start guide for serosolver</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/seroanalytics/serosolver">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Adaptive Metropolis-within-Gibbs/Metropolis Hastings Random Walk Algorithm.</h1>
    <small class="dont-index">Source: <a href='https://github.com/seroanalytics/serosolver/blob/master/R/mcmc.R'><code>R/mcmc.R</code></a></small>
    <div class="hidden name"><code>serosolver.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The Adaptive Metropolis-within-Gibbs algorithm. Given a starting point and the necessary MCMC parameters as set out below, performs a random-walk of the posterior space to produce an MCMC chain that can be used to generate MCMC density and iteration plots. The algorithm undergoes an adaptive period, where it changes the step size of the random walk for each parameter to approach the desired acceptance rate, popt. The algorithm then uses <code><a href='univ_proposal.html'>univ_proposal</a></code> or <code><a href='mvr_proposal.html'>mvr_proposal</a></code> to explore parameter space, recording the value and posterior value at each step. The MCMC chain is saved in blocks as a .csv file at the location given by filename. This version of the algorithm is also designed to explore posterior densities for infection histories. See the package vignettes for examples.</p>
    </div>

    <pre class="usage"><span class='fu'>serosolver</span>(
  <span class='no'>par_tab</span>,
  <span class='no'>titre_dat</span>,
  <span class='kw'>antigenic_map</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>strain_isolation_times</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>mcmc_pars</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(),
  <span class='kw'>mvr_pars</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>start_inf_hist</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>filename</span> <span class='kw'>=</span> <span class='st'>"test"</span>,
  <span class='kw'>CREATE_POSTERIOR_FUNC</span> <span class='kw'>=</span> <span class='no'>create_posterior_func</span>,
  <span class='kw'>CREATE_PRIOR_FUNC</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>version</span> <span class='kw'>=</span> <span class='fl'>1</span>,
  <span class='kw'>mu_indices</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>measurement_indices</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>measurement_random_effects</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>proposal_ratios</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>OPT_TUNING</span> <span class='kw'>=</span> <span class='fl'>0.1</span>,
  <span class='kw'>temp</span> <span class='kw'>=</span> <span class='fl'>1</span>,
  <span class='kw'>solve_likelihood</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>n_alive</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='no'>...</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>par_tab</th>
      <td><p>The parameter table controlling information such as bounds, initial values etc. See <code><a href='example_par_tab.html'>example_par_tab</a></code></p></td>
    </tr>
    <tr>
      <th>titre_dat</th>
      <td><p>The data frame of titre data to be fitted. Must have columns: group (index of group); individual (integer ID of individual); samples (numeric time of sample taken); virus (numeric time of when the virus was circulating); titre (integer of titre value against the given virus at that sampling time); run (integer giving the repeated number of this titre); DOB (integer giving date of birth matching time units used in model). See <code><a href='example_titre_dat.html'>example_titre_dat</a></code></p></td>
    </tr>
    <tr>
      <th>antigenic_map</th>
      <td><p>(optional) A data frame of antigenic x and y coordinates. Must have column names: x_coord; y_coord; inf_times. See <code><a href='example_antigenic_map.html'>example_antigenic_map</a></code></p></td>
    </tr>
    <tr>
      <th>strain_isolation_times</th>
      <td><p>(optional) If no antigenic map is specified, this argument gives the vector of times at which individuals can be infected</p></td>
    </tr>
    <tr>
      <th>mcmc_pars</th>
      <td><p>Named vector named vector with parameters for the MCMC procedure. See details</p></td>
    </tr>
    <tr>
      <th>mvr_pars</th>
      <td><p>Leave NULL to use univariate proposals. Otherwise, a list of parameters if using a multivariate proposal. Must contain an initial covariance matrix, weighting for adapting cov matrix, and an initial scaling parameter (0-1)</p></td>
    </tr>
    <tr>
      <th>start_inf_hist</th>
      <td><p>Infection history matrix to start MCMC at. Can be left NULL. See <code><a href='example_inf_hist.html'>example_inf_hist</a></code></p></td>
    </tr>
    <tr>
      <th>filename</th>
      <td><p>The full filepath at which the MCMC chain should be saved. "_chain.csv" will be appended to the end of this, so filename should have no file extensions</p></td>
    </tr>
    <tr>
      <th>CREATE_POSTERIOR_FUNC</th>
      <td><p>Pointer to posterior function used to calculate a likelihood. This will probably be <code><a href='create_posterior_func.html'>create_posterior_func</a></code></p></td>
    </tr>
    <tr>
      <th>CREATE_PRIOR_FUNC</th>
      <td><p>User function of prior for model parameters. Should take parameter values only</p></td>
    </tr>
    <tr>
      <th>version</th>
      <td><p>which infection history assumption version to use? See <code><a href='describe_priors.html'>describe_priors</a></code> for options. Can be 1, 2, 3 or 4</p></td>
    </tr>
    <tr>
      <th>mu_indices</th>
      <td><p>optional NULL. For random effects on boosting parameter, mu. Vector of indices of length equal to number of circulation times. If random mus are included in the parameter table, this vector specifies which mu to use for each circulation year. For example, if years 1970-1976 have unique boosting, then mu_indices should be c(1,2,3,4,5,6). If every 3 year block shares has a unique boosting parameter, then this should be c(1,1,1,2,2,2)</p></td>
    </tr>
    <tr>
      <th>measurement_indices</th>
      <td><p>optional NULL. For measurement bias function. Vector of indices of length equal to number of circulation times. For each year, gives the index of parameters named "rho" that correspond to each time period</p></td>
    </tr>
    <tr>
      <th>measurement_random_effects</th>
      <td><p>optional FALSE. Boolean indicating if measurement bias is a random effects term. If TRUE adds a component to the posterior calculation that calculates the probability of a set of measurement shifts "rho", given a mean and standard deviation</p></td>
    </tr>
    <tr>
      <th>proposal_ratios</th>
      <td><p>optional NULL. Can set the relative sampling weights of the infection state times. Should be an integer vector of length matching nrow(antigenic_map). Otherwise, leave as NULL for uniform sampling.</p></td>
    </tr>
    <tr>
      <th>OPT_TUNING</th>
      <td><p>Constant describing the amount of leeway when adapting the proposals steps to reach a desired acceptance rate (ie. does not change step size if within OPT_TUNING of the specified acceptance rate)</p></td>
    </tr>
    <tr>
      <th>temp</th>
      <td><p>Temperature term for parallel tempering, raises likelihood to this value. Just used for testing at this point</p></td>
    </tr>
    <tr>
      <th>solve_likelihood</th>
      <td><p>if FALSE, returns only the prior and does not solve the likelihood. Use this if you wish to sample directly from the prior</p></td>
    </tr>
    <tr>
      <th>n_alive</th>
      <td><p>if not NULL, uses this as the number alive for the infection history prior, rather than calculating the number alive based on titre_dat</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Other arguments to pass to CREATE_POSTERIOR_FUNC</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A list with: 1) relative file path at which the MCMC chain is saved as a .csv file; 2) relative file path at which the infection history chain is saved as a .csv file; 3) the last used covariance matrix if mvr_pars != NULL; 4) the last used scale/step size (if multivariate proposals) or vector of step sizes (if univariate proposals)</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The <code>mcmc_pars</code> argument has the following options:</p><ul>
<li><p>iterations (number of post adaptive period iterations to run)</p></li>
<li><p>adaptive_period (for this many iterations, change proposal step size adaptively every <code>opt_freq</code> iterations)</p></li>
<li><p>opt_freq (adapt proposal step size every opt_freq iterations)</p></li>
<li><p>thin (save every n iterations)</p></li>
<li><p>thin_hist (infection history thinning)</p></li>
<li><p>hist_sample_prob (proportion of individuals resampled at each iteration)</p></li>
<li><p>save_block (after this many iterations (post thinning), save to disk)</p></li>
<li><p>popt (desired acceptance rate for parameters)</p></li>
<li><p>popt_hist (desired acceptance rate for infection histories)</p></li>
<li><p>switch_sample (ratio of infection history samples to theta samples ie. switch_sample = 2 means sample inf hist twice for every theta sample, switch_sample = 0.5 means sample theta twice for every inf hist sample)</p></li>
<li><p>inf_propn (proportion of infection times to resample for each individual at each iteration)</p></li>
<li><p>move_size (number of infection years/months to move when performing infection history swap step)</p></li>
<li><p>hist_opt (if 1, performs adaptive infection history proposals. If 0, retains the starting infection history proposal parameters. This should ONLY be turned on for prior version 2)</p></li>
<li><p>swap_propn (if using gibbs sampling of infection histories, what proportion of proposals should be swap steps)</p></li>
<li><p>hist_switch_prob (proportion of infection history proposal steps to swap year_swap_propn of two time periods' contents)</p></li>
<li><p>year_swap_propn (when swapping contents of two time points, what proportion of individuals should have their contents swapped)</p></li>
</ul>

    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><a href='https://github.com/jameshay218/lazymcmc'>https://github.com/jameshay218/lazymcmc</a></p>
<p>Other mcmc: 
<code><a href='generate_start_tab.html'>generate_start_tab</a>()</code>,
<code><a href='rm_scale.html'>rm_scale</a>()</code>,
<code><a href='save_infection_history_to_disk.html'>save_infection_history_to_disk</a>()</code>,
<code><a href='scaletuning.html'>scaletuning</a>()</code></p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> (<span class='fl'>FALSE</span>) {
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>example_titre_dat</span>)
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>example_par_tab</span>)
<span class='fu'><a href='https://rdrr.io/r/utils/data.html'>data</a></span>(<span class='no'>example_antigenic_map</span>)
<span class='no'>res</span> <span class='kw'>&lt;-</span> <span class='fu'>serosolver</span>(<span class='no'>example_par_tab</span>[<span class='no'>example_par_tab</span>$<span class='no'>names</span> <span class='kw'>!=</span> <span class='st'>"phi"</span>,], <span class='no'>example_titre_dat</span>, <span class='no'>example_antigenic_map</span>, <span class='kw'>version</span><span class='kw'>=</span><span class='fl'>2</span>)
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      <li><a href="#value">Value</a></li>
      <li><a href="#details">Details</a></li>
      <li><a href="#see-also">See also</a></li>
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by James Hay, Adam Kucharski, Kylie Ainslie, Amanda Minter, Steven Riley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


