<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paper case study 2: serosolver • serosolver</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Paper case study 2: serosolver">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">serosolver</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cs1_vignette.html">Paper case study 1: serosolver</a>
    </li>
    <li>
      <a href="../articles/cs2_vignette.html">Paper case study 2: serosolver</a>
    </li>
    <li>
      <a href="../articles/serosolver-quick_start_guide.html">Quick start guide for serosolver</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/seroanalytics/serosolver">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Paper case study 2: serosolver</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/seroanalytics/serosolver/blob/master/vignettes/cs2_vignette.Rmd"><code>vignettes/cs2_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>cs2_vignette.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>This vignette provides all of the analysis for case study 2 in the accompanying package and paper. Briefly, the aim is to infer antibody kinetics and historical attack rates using cross-sectional haemagglutination inhibition titre data on a panel of recent and historical A/H3N2 strains. All of the functions used here are well documented and have many tunable arguments, and we therefore encourage users to refer to the helps files.</p>
<p>This vignette demonstrates only how to reproduce the MCMC chains, simulate data, assess model fits and assess chain convergence. Code to reproduce figures from the main text in the accompanying paper can be found in the <a href="https://github.com/seroanalytics/serosolver/tree/master/inst/extdata/scripts"><code>inst/extdata/scripts</code></a> folder of the package.</p>
</div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<div id="installation-and-requirements" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-and-requirements" class="anchor"></a>Installation and requirements</h2>
<p><code>serosolver</code> may be installed from github using the <code>devtools</code> package. There are a number of additional packages that we need for this analysis.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Required to run serosolver</span></a>
<a class="sourceLine" id="cb1-2" title="2">devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">"seroanalytics/serosolver"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(serosolver)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(plyr)</a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(data.table)</a>
<a class="sourceLine" id="cb1-6" title="6"></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co">## Required for this analysis</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(reshape2)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(foreach)</a>
<a class="sourceLine" id="cb1-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(doParallel)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(bayesplot)</a>
<a class="sourceLine" id="cb1-12" title="12"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(coda)</a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-14" title="14"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(viridis)</a>
<a class="sourceLine" id="cb1-15" title="15"></a>
<a class="sourceLine" id="cb1-16" title="16"><span class="co"># set up cluster</span></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1234</span>)</a>
<a class="sourceLine" id="cb1-18" title="18">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">5</span>)</a>
<a class="sourceLine" id="cb1-19" title="19"><span class="kw">registerDoParallel</span>(cl)</a>
<a class="sourceLine" id="cb1-20" title="20"></a>
<a class="sourceLine" id="cb1-21" title="21"><span class="co">## Note that this vignette was generated on a Windows machine,</span></a>
<a class="sourceLine" id="cb1-22" title="22"><span class="co">## and the setup for parallelisation is different on a Linux machine</span></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="co">## for Linux machine:</span></a>
<a class="sourceLine" id="cb1-24" title="24"><span class="co">#  library(doMC)</span></a>
<a class="sourceLine" id="cb1-25" title="25"><span class="co">#  library(doRNG)</span></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="co">#  registerDoMC(cores=5)</span></a></code></pre></div>
</div>
<div id="assumptions" class="section level2">
<h2 class="hasAnchor">
<a href="#assumptions" class="anchor"></a>Assumptions</h2>
<p>In this analysis, all serological samples were taken in 2009 and therefore all time variables are relative to this year. We are interested in inferring infections and attack rates at an annual resolution, and therefore set <code>resolution</code> to 1. Our primary outcome of interest is to infer unbiased historical attack rates, and we therefore use the version of the code with a Beta prior on per-time attack rates, <code>prior_version=2</code>. Furthermore, we have found that in the situation where the number of possible infections to infer is large but the amount of data is relatively sparse, identifiability is poor when using reference priors (eg. uniform Beta or Jeffrey’s prior). We instead opted to use a weakly informative prior for annual attack rates with mode = 0.15 but with high variance, corresponding to prior observations of annual influenza attack rates. We set these parameters at the start of the analysis.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">filename &lt;-<span class="st"> "case_study_2"</span></a>
<a class="sourceLine" id="cb2-2" title="2">resolution &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co">## eg. this would be set to 12 for monthly resolution</span></a>
<a class="sourceLine" id="cb2-3" title="3">sample_year &lt;-<span class="st"> </span><span class="dv">2009</span></a>
<a class="sourceLine" id="cb2-4" title="4"></a>
<a class="sourceLine" id="cb2-5" title="5">serosolver<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/serosolver/man/describe_priors.html">describe_priors</a></span>()</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">#&gt; Which version to use in serosolver? The following text describes the proposal step for updating infection histories.</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co">#&gt; Version 1: Beta prior on per time attack rates. Explicit FOI on each epoch using probability of infection term. Proposal performs N `flip` proposals at random locations in an individual's infection history, switching 1-&gt;0 or 0-&gt;1. Otherwise, swaps the contents of two random locations</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">#&gt; Version 2: Beta prior on per time attack rates. Gibbs sampling of infection histories as in Indian Buffet Process papers, integrating out each probability of infection term.</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co">#&gt; Version 3: Beta prior on probability of infection for an individual, assuming independence between individuals. Samples from a beta binomial with alpha and beta specified by the par_tab input. Proposes nInfs moves at a time for add/remove, or when swapping, swaps locations up to moveSize time steps away</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">#&gt; Version 4: Beta prior on probability of any infection. Gibbs sampling of infection histories using total number of infections across all times and all individuals as the prior</span></a>
<a class="sourceLine" id="cb2-11" title="11">prior_version &lt;-<span class="st"> </span><span class="dv">2</span></a></code></pre></div>
</div>
<div id="preparing-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-the-data" class="anchor"></a>Preparing the data</h2>
<p>The data used in this analysis are haemagglutination inhibition (HI) titres against a number of A/H3N2 that have circulated since 1968. The raw data are in a wide format, providing the highest two-fold dilution of serum at which haemagglutination is inhibited. The first step of the analysis is therefore to clean the titre data and convert the data frame to the long format, as described in the quickstart vignette.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co">## Read in data</span></a>
<a class="sourceLine" id="cb3-2" title="2">raw_dat_path &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"Fluscape_HI_data.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)</a>
<a class="sourceLine" id="cb3-3" title="3">raw_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="dt">file =</span> raw_dat_path, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(raw_dat))</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#&gt;   Age HI.H3N2.1968 HI.H3N2.1975 HI.H3N2.1979 HI.H3N2.1989 HI.H3N2.1995</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; 1  75           80           40           40           80          160</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; 2  35           20           80          160           40           80</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; 3  71           80           40           20           20           40</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; 4  65           80           40           40           20           40</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt; 5  64          160           80           40           10           40</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt; 6  33           40           20          160           80           80</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt;   HI.H3N2.2002 HI.H3N2.2003 HI.H3N2.2005 HI.H3N2.2008</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt; 1          160           40           80           40</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#&gt; 2           20           10            0            0</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#&gt; 3           80           20           10            0</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#&gt; 4           20            0            0            0</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#&gt; 5           40            0           20           20</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="co">#&gt; 6          160           40           40           20</span></a>
<a class="sourceLine" id="cb3-19" title="19"></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">## Add indexing column for each individual</span></a>
<a class="sourceLine" id="cb3-21" title="21">raw_dat<span class="op">$</span>individual &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(raw_dat)</a>
<a class="sourceLine" id="cb3-22" title="22"></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co">## Convert data to long format</span></a>
<a class="sourceLine" id="cb3-24" title="24">melted_dat &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(raw_dat, <span class="dt">id.vars=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"individual"</span>,<span class="st">"Age"</span>),<span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co">## Modify column names to meet serosolver's expectations</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(melted_dat) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"individual"</span>,<span class="st">"DOB"</span>,<span class="st">"virus"</span>,<span class="st">"titre"</span>)</a>
<a class="sourceLine" id="cb3-28" title="28">melted_dat<span class="op">$</span>virus &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(melted_dat<span class="op">$</span>virus)</a>
<a class="sourceLine" id="cb3-29" title="29"></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="co">## Extract circulation years for each virus code, which will be used </span></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co">## by serosolver as the circulation time</span></a>
<a class="sourceLine" id="cb3-32" title="32">melted_dat<span class="op">$</span>virus &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(melted_dat<span class="op">$</span>virus, <span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(x,<span class="dt">split =</span> <span class="st">"HI.H3N2."</span>)[[<span class="dv">1</span>]][<span class="dv">2</span>]))</a>
<a class="sourceLine" id="cb3-33" title="33"></a>
<a class="sourceLine" id="cb3-34" title="34"><span class="co">## Clean and log transform the data</span></a>
<a class="sourceLine" id="cb3-35" title="35">melted_dat &lt;-<span class="st"> </span>melted_dat[<span class="kw"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span>(melted_dat),]</a>
<a class="sourceLine" id="cb3-36" title="36">melted_dat[melted_dat<span class="op">$</span>titre <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,<span class="st">"titre"</span>] &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb3-37" title="37">melted_dat<span class="op">$</span>titre &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">log2</a></span>(melted_dat<span class="op">$</span>titre<span class="op">/</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb3-38" title="38"></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="co">## Convert ages to DOB</span></a>
<a class="sourceLine" id="cb3-40" title="40">melted_dat<span class="op">$</span>DOB &lt;-<span class="st"> </span>sample_year <span class="op">-</span><span class="st"> </span>melted_dat<span class="op">$</span>DOB</a>
<a class="sourceLine" id="cb3-41" title="41"></a>
<a class="sourceLine" id="cb3-42" title="42"><span class="co">## All samples taken at the same time</span></a>
<a class="sourceLine" id="cb3-43" title="43">melted_dat<span class="op">$</span>samples &lt;-<span class="st"> </span>sample_year</a>
<a class="sourceLine" id="cb3-44" title="44"></a>
<a class="sourceLine" id="cb3-45" title="45"><span class="co">## Add column for titre repeats, enumerating for each measurement for the same virus/sample/individual</span></a>
<a class="sourceLine" id="cb3-46" title="46">melted_dat &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span>(melted_dat,.(individual,virus,samples),<span class="cf">function</span>(x) <span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(x,<span class="st">"run"</span>=<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(x),<span class="st">"group"</span>=<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb3-47" title="47"></a>
<a class="sourceLine" id="cb3-48" title="48"><span class="co">## Rename to data expected by serosolver</span></a>
<a class="sourceLine" id="cb3-49" title="49">titre_dat &lt;-<span class="st"> </span>melted_dat</a>
<a class="sourceLine" id="cb3-50" title="50"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(titre_dat))</a>
<a class="sourceLine" id="cb3-51" title="51"><span class="co">#&gt;   individual  DOB virus titre samples run group</span></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co">#&gt; 1          1 1934  1968     4    2009   1     1</span></a>
<a class="sourceLine" id="cb3-53" title="53"><span class="co">#&gt; 2          1 1934  1975     3    2009   1     1</span></a>
<a class="sourceLine" id="cb3-54" title="54"><span class="co">#&gt; 3          1 1934  1979     3    2009   1     1</span></a>
<a class="sourceLine" id="cb3-55" title="55"><span class="co">#&gt; 4          1 1934  1989     4    2009   1     1</span></a>
<a class="sourceLine" id="cb3-56" title="56"><span class="co">#&gt; 5          1 1934  1995     5    2009   1     1</span></a>
<a class="sourceLine" id="cb3-57" title="57"><span class="co">#&gt; 6          1 1934  2002     5    2009   1     1</span></a></code></pre></div>
<p>Given that this analysis uses titres from multiple, antigenically related viruses, it is necessary to define an antigenic map describing the antigenic distance between all of the viruses here. We use coordinates based on the antigenic map created by Fonville et al. Generating the antigenic map involves fitting a smoothing spline through provided coordinates to give a representative virus for each time point (in this case, each year) that an individual could be infected. This process also inputs antigenic coordinates for time points that we do not have a measured virus.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co">## Read in raw coordinates</span></a>
<a class="sourceLine" id="cb4-2" title="2">antigenic_coords_path &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"fonville_map_approx.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)</a>
<a class="sourceLine" id="cb4-3" title="3">antigenic_coords &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="dt">file =</span> antigenic_coords_path, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(antigenic_coords))</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#&gt;   Strain    X    Y</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#&gt; 1   HK68  1.8  2.4</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#&gt; 2   EN72  2.7  4.9</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#&gt; 3   VI75  7.6  6.3</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#&gt; 4   TX77  7.9  8.8</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#&gt; 5   BK79  9.6 11.0</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#&gt; 6   SI87 15.0  6.8</span></a>
<a class="sourceLine" id="cb4-12" title="12"></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">## Convert to form expected by serosolver</span></a>
<a class="sourceLine" id="cb4-14" title="14">antigenic_map &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_antigenic_map.html">generate_antigenic_map</a></span>(antigenic_coords, resolution)</a>
<a class="sourceLine" id="cb4-15" title="15"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(antigenic_map))</a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co">#&gt;       x_coord   y_coord inf_times</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co">#&gt; 1 -0.09718111 0.5021363      1968</span></a>
<a class="sourceLine" id="cb4-18" title="18"><span class="co">#&gt; 2  0.80502804 1.6816917      1969</span></a>
<a class="sourceLine" id="cb4-19" title="19"><span class="co">#&gt; 3  1.70723718 2.8612472      1970</span></a>
<a class="sourceLine" id="cb4-20" title="20"><span class="co">#&gt; 4  2.60944633 3.9976902      1971</span></a>
<a class="sourceLine" id="cb4-21" title="21"><span class="co">#&gt; 5  3.51165548 4.8709093      1972</span></a>
<a class="sourceLine" id="cb4-22" title="22"><span class="co">#&gt; 6  4.41386463 5.5057039      1973</span></a>
<a class="sourceLine" id="cb4-23" title="23"></a>
<a class="sourceLine" id="cb4-24" title="24"><span class="co">## More flexible version of the above function</span></a>
<a class="sourceLine" id="cb4-25" title="25">virus_key &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(</a>
<a class="sourceLine" id="cb4-26" title="26">    <span class="st">"HK68"</span> =<span class="st"> </span><span class="dv">1968</span>, <span class="st">"EN72"</span> =<span class="st"> </span><span class="dv">1972</span>, <span class="st">"VI75"</span> =<span class="st"> </span><span class="dv">1975</span>, <span class="st">"TX77"</span> =<span class="st"> </span><span class="dv">1977</span>, </a>
<a class="sourceLine" id="cb4-27" title="27">    <span class="st">"BK79"</span> =<span class="st"> </span><span class="dv">1979</span>, <span class="st">"SI87"</span> =<span class="st"> </span><span class="dv">1987</span>, <span class="st">"BE89"</span> =<span class="st"> </span><span class="dv">1989</span>, <span class="st">"BJ89"</span> =<span class="st"> </span><span class="dv">1989</span>,</a>
<a class="sourceLine" id="cb4-28" title="28">    <span class="st">"BE92"</span> =<span class="st"> </span><span class="dv">1992</span>, <span class="st">"WU95"</span> =<span class="st"> </span><span class="dv">1995</span>, <span class="st">"SY97"</span> =<span class="st"> </span><span class="dv">1997</span>, <span class="st">"FU02"</span> =<span class="st"> </span><span class="dv">2002</span>, </a>
<a class="sourceLine" id="cb4-29" title="29">    <span class="st">"CA04"</span> =<span class="st"> </span><span class="dv">2004</span>, <span class="st">"WI05"</span> =<span class="st"> </span><span class="dv">2005</span>, <span class="st">"PE06"</span> =<span class="st"> </span><span class="dv">2006</span></a>
<a class="sourceLine" id="cb4-30" title="30">  )</a>
<a class="sourceLine" id="cb4-31" title="31">antigenic_coords<span class="op">$</span>Strain &lt;-<span class="st"> </span>virus_key[antigenic_coords<span class="op">$</span>Strain]</a>
<a class="sourceLine" id="cb4-32" title="32">antigenic_map &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_antigenic_map_flexible.html">generate_antigenic_map_flexible</a></span>(antigenic_coords)</a>
<a class="sourceLine" id="cb4-33" title="33"></a>
<a class="sourceLine" id="cb4-34" title="34"><span class="co">## Restrict entries to years of interest. Entries in antigenic_map determine</span></a>
<a class="sourceLine" id="cb4-35" title="35"><span class="co">## the times that individual can be infected ie. the dimensions of the infection</span></a>
<a class="sourceLine" id="cb4-36" title="36"><span class="co">## history matrix.</span></a>
<a class="sourceLine" id="cb4-37" title="37">antigenic_map &lt;-<span class="st"> </span>antigenic_map[antigenic_map<span class="op">$</span>inf_times <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1968</span> <span class="op">&amp;</span><span class="st"> </span>antigenic_map<span class="op">$</span>inf_times <span class="op">&lt;=</span><span class="st"> </span>sample_year,]</a>
<a class="sourceLine" id="cb4-38" title="38">strain_isolation_times &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(antigenic_map<span class="op">$</span>inf_times)</a></code></pre></div>
<p>NOTE: <code>generate_antigenic_map</code> expects the provided file <code>fonville_map_approx.csv</code>. Users should refer to <code>generate_antigenic_map_flexible</code> for more generic antigenic map generation.</p>
<p>Finally, we must specify the <code>par_tab</code> data frame, which controls which parameters are included in the model, which are fixed, and their uniform prior ranges. Given that we are integrating out the probability of infection terms under prior version 2, we must remove these parameters from <code>par_tab</code>. Furthermore, given that we are interested in long-term dynamics with relatively sparse data, we remove parameters relating to the short-term antibody kinetics phase to avoid identifiability issues. We set alpha and beta of the beta prior to give a mode of 0.15 assuming that our prior belief has the equivalent weighting to 4 observed individuals.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">par_tab_path &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"par_tab_base.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">par_tab &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="dt">file =</span> par_tab_path, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">## Set parameters for Beta prior on infection histories</span></a>
<a class="sourceLine" id="cb5-5" title="5">beta_pars &lt;-<span class="st"> </span><span class="kw"><a href="../reference/find_beta_prior_mode.html">find_beta_prior_mode</a></span>(<span class="fl">0.15</span>,<span class="dv">4</span>)</a>
<a class="sourceLine" id="cb5-6" title="6">par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "alpha"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span>beta_pars<span class="op">$</span>alpha</a>
<a class="sourceLine" id="cb5-7" title="7">par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "beta"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span>beta_pars<span class="op">$</span>beta</a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">## Maximum recordable log titre in these data is 8</span></a>
<a class="sourceLine" id="cb5-9" title="9">par_tab[par_tab<span class="op">$</span>names <span class="op">==</span><span class="st"> "MAX_TITRE"</span>,<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">8</span></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">## Remove phi parameters, as these are integrated out under prior version 2</span></a>
<a class="sourceLine" id="cb5-12" title="12">par_tab &lt;-<span class="st"> </span>par_tab[par_tab<span class="op">$</span>names <span class="op">!=</span><span class="st"> "phi"</span>,]</a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">## Fix all short term parameters to 0</span></a>
<a class="sourceLine" id="cb5-15" title="15">par_tab[par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mu_short"</span>,<span class="st">"sigma2"</span>,<span class="st">"wane"</span>),<span class="st">"fixed"</span>] &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># mu_short, waning and sigma2 are fixed</span></a>
<a class="sourceLine" id="cb5-16" title="16">par_tab[par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mu_short"</span>,<span class="st">"sigma2"</span>,<span class="st">"wane"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="dv">0</span> <span class="co"># set these values to 0</span></a></code></pre></div>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>

</div>
</div>
<div id="running-the-mcmc" class="section level1">
<h1 class="hasAnchor">
<a href="#running-the-mcmc" class="anchor"></a>Running the MCMC</h1>
<p>We are now ready to fit our model. We will fit multiple chains in parallel, though the below analysis could easily be replicated by running chains sequentially. Starting conditions for the MCMC chain must be generated that return a finite likelihood. The user may modify many of the MCMC control parameters, though the defaults are fine for most purposes. We have made some minor tweaks in this case study to improve convergence on infection history estimates. Step sizes for parameters in <code>par_tab</code> are tuned automatically, and some automated tuning of the infection history proposals takes place for prior version 3. However, for other attack rate priors, it is necessary for the user to do some manual tuning of a) the number of individuals sampled at each step <code>proposal_inf_hist_indiv_prop</code>; b) the number of time points sampled at each step <code>proposal_inf_hist_time_prop</code>; c) the frequency of individual infection history swapping steps (ie. for an individual, choose two time points and swap their contents)<code>proposal_inf_hist_indiv_swap_ratio</code>; d) proportion of infection history sampling steps which should be the alternative swapping step, where the contents of infection histories at two time points are swapped <code>proposal_inf_hist_group_swap_ratio</code>; e) proportion of infection histories to swap with each alternative swapping step <code>proposal_inf_hist_group_swap_prop</code>. For example, in this case study, we attack rates are likely to be highly correlated in adjacent years (as we have limited data to distinguish between infections in years close in time), and we therefore increase the frequency of the alternative infection history swapping step with <code>proposal_inf_hist_group_swap_prop</code>.</p>
<p>Changing the number of iterations and the length of the adaptive period are often desirable. More crucially, the amount of chain thinning should be specified to ensure that users are not saving a large number of MCMC iterations (as this will rapidly fill disk space!). Thinning should be set such that at least 1000 iterations are saved (ie. <code>iterations</code>/<code>thin</code> and <code>thin_inf_hist</code>). Users are encouraged to pay extra attention to <code>thin_inf_hist</code>, which dictates the thinning of the infection history chain, and can generate a very large file if left unchecked.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co">## Distinct filename for each chain</span></a>
<a class="sourceLine" id="cb6-2" title="2">no_chains &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb6-3" title="3">filenames &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(filename, <span class="st">"_"</span>,<span class="dv">1</span><span class="op">:</span>no_chains)</a>
<a class="sourceLine" id="cb6-4" title="4">chain_path &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/grep.html">sub</a></span>(<span class="st">"par_tab_base.csv"</span>,<span class="st">""</span>,par_tab_path)</a>
<a class="sourceLine" id="cb6-5" title="5">chain_path_real &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(chain_path, <span class="st">"cs2_real/"</span>)</a>
<a class="sourceLine" id="cb6-6" title="6">chain_path_sim &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(chain_path, <span class="st">"cs2_sim/"</span>)</a>
<a class="sourceLine" id="cb6-7" title="7"></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">## Create the posterior solving function that will be used in the MCMC framework </span></a>
<a class="sourceLine" id="cb6-9" title="9">model_func &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_posterior_func.html">create_posterior_func</a></span>(<span class="dt">par_tab=</span>par_tab,</a>
<a class="sourceLine" id="cb6-10" title="10">                                <span class="dt">titre_dat=</span>titre_dat,</a>
<a class="sourceLine" id="cb6-11" title="11">                                <span class="dt">antigenic_map=</span>antigenic_map,</a>
<a class="sourceLine" id="cb6-12" title="12">                                <span class="dt">version=</span>prior_version) <span class="co"># function in posteriors.R</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#&gt; Creating posterior solving function...</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co">#&gt; </span></a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co">## Generate results in parallel</span></a>
<a class="sourceLine" id="cb7-2" title="2">res &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">x =</span> filenames, <span class="dt">.packages =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'serosolver'</span>,<span class="st">'data.table'</span>,<span class="st">'plyr'</span>)) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="co">## Not all random starting conditions return finite likelihood, so for each chain generate random</span></a>
<a class="sourceLine" id="cb7-4" title="4">  <span class="co">## conditions until we get one with a finite likelihood</span></a>
<a class="sourceLine" id="cb7-5" title="5">  start_prob &lt;-<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb7-6" title="6">  <span class="cf">while</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span>(start_prob)){</a>
<a class="sourceLine" id="cb7-7" title="7">    <span class="co">## Generating starting antibody kinetics parameters</span></a>
<a class="sourceLine" id="cb7-8" title="8">    start_tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_start_tab.html">generate_start_tab</a></span>(par_tab)</a>
<a class="sourceLine" id="cb7-9" title="9">    </a>
<a class="sourceLine" id="cb7-10" title="10">    <span class="co">## Generate starting infection history</span></a>
<a class="sourceLine" id="cb7-11" title="11">    start_inf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setup_infection_histories_titre.html">setup_infection_histories_titre</a></span>(titre_dat, strain_isolation_times, </a>
<a class="sourceLine" id="cb7-12" title="12">                                                 <span class="dt">space=</span><span class="dv">3</span>,<span class="dt">titre_cutoff=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb7-13" title="13">    start_prob &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">model_func</span>(start_tab<span class="op">$</span>values, start_inf)[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb7-14" title="14">  }</a>
<a class="sourceLine" id="cb7-15" title="15">  </a>
<a class="sourceLine" id="cb7-16" title="16">  </a>
<a class="sourceLine" id="cb7-17" title="17">  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/serosolver.html">serosolver</a></span>(<span class="dt">par_tab =</span> start_tab, </a>
<a class="sourceLine" id="cb7-18" title="18">                  <span class="dt">titre_dat =</span> titre_dat,</a>
<a class="sourceLine" id="cb7-19" title="19">                  <span class="dt">antigenic_map =</span> antigenic_map,</a>
<a class="sourceLine" id="cb7-20" title="20">                  <span class="dt">start_inf_hist =</span> start_inf, </a>
<a class="sourceLine" id="cb7-21" title="21">                  <span class="dt">mcmc_pars =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iterations"</span>=<span class="dv">500000</span>,<span class="st">"adaptive_iterations"</span>=<span class="dv">100000</span>,<span class="st">"thin"</span>=<span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb7-22" title="22">                                <span class="st">"thin_inf_hist"</span>=<span class="dv">1000</span>,<span class="st">"save_block"</span>=<span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb7-23" title="23">                                <span class="st">"proposal_inf_hist_time_prop"</span>=<span class="dv">1</span>, <span class="st">"proposal_inf_hist_indiv_prop"</span>=<span class="dv">1</span>,</a>
<a class="sourceLine" id="cb7-24" title="24">                                <span class="st">"proposal_inf_hist_group_swap_ratio"</span>=<span class="fl">0.8</span>, <span class="st">"proposal_inf_hist_group_swap_prop"</span>=<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb7-25" title="25">                  <span class="dt">filename =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(chain_path_real,x), </a>
<a class="sourceLine" id="cb7-26" title="26">                  <span class="dt">CREATE_POSTERIOR_FUNC =</span> create_posterior_func, </a>
<a class="sourceLine" id="cb7-27" title="27">                  <span class="dt">version =</span> prior_version)</a>
<a class="sourceLine" id="cb7-28" title="28">}</a></code></pre></div>
</div>
<div id="post-run-analyses" class="section level1">
<h1 class="hasAnchor">
<a href="#post-run-analyses" class="anchor"></a>Post-run analyses</h1>
<p>Once the MCMC chains are run, <code>serosolver</code> provides a number of simple functions to generate standard outputs and MCMC diagnostics. The saved MCMC chains are compatible with the <code>coda</code> and <code>bayesplot</code> packages, and users are encouraged to use these. First, read in the MCMC chains. The below function distinguishes between posterior samples for the infection history matrix and for the process parameters. The function searches for all files with the filenames generated by <code>serosolver</code> in the specified directory, and returns data structures with these concatenated and seperated in a list.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co">## Read in the MCMC chains</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">## Note that `thin` here is in addition to any thinning done during the fitting</span></a>
<a class="sourceLine" id="cb8-3" title="3">all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_real,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,</a>
<a class="sourceLine" id="cb8-4" title="4">                               <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#&gt; Chains detected: </span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_1_infection_histories.csv</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_2_infection_histories.csv</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_3_infection_histories.csv</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_4_infection_histories.csv</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_5_infection_histories.csv</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#&gt; [1] 643851</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co">#&gt; [1] 650759</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb8-19" title="19"><span class="co">#&gt; [1] 640438</span></a>
<a class="sourceLine" id="cb8-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-21" title="21"><span class="co">#&gt; [[4]]</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="co">#&gt; [1] 645224</span></a>
<a class="sourceLine" id="cb8-23" title="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb8-24" title="24"><span class="co">#&gt; [[5]]</span></a>
<a class="sourceLine" id="cb8-25" title="25"><span class="co">#&gt; [1] 648570</span></a>
<a class="sourceLine" id="cb8-26" title="26"></a>
<a class="sourceLine" id="cb8-27" title="27"><span class="co">## Alternative, load the included MCMC chains rather than re-running</span></a>
<a class="sourceLine" id="cb8-28" title="28"><span class="co">## data(cs2_chains_real)</span></a>
<a class="sourceLine" id="cb8-29" title="29"><span class="co">## all_chains &lt;- cs2_chains_real</span></a>
<a class="sourceLine" id="cb8-30" title="30"></a>
<a class="sourceLine" id="cb8-31" title="31"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(all_chains))</a>
<a class="sourceLine" id="cb8-32" title="32"><span class="co">#&gt;                   Length Class      Mode   </span></a>
<a class="sourceLine" id="cb8-33" title="33"><span class="co">#&gt; theta_chain       65130  mcmc       numeric</span></a>
<a class="sourceLine" id="cb8-34" title="34"><span class="co">#&gt; inf_chain             5  data.table list   </span></a>
<a class="sourceLine" id="cb8-35" title="35"><span class="co">#&gt; theta_list_chains     5  -none-     list   </span></a>
<a class="sourceLine" id="cb8-36" title="36"><span class="co">#&gt; inf_list_chains       5  -none-     list</span></a></code></pre></div>
<p>Chains should then be checked for the usual MCMC diagnostics: <span class="math inline">\(\hat{R}\)</span> and effective sample size. First, looking at the antibody kinetics process parameters:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co">## Get the MCMC chains as a list</span></a>
<a class="sourceLine" id="cb9-2" title="2">list_chains &lt;-<span class="st"> </span>all_chains<span class="op">$</span>theta_list_chains</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">## Look at diagnostics for the free parameters</span></a>
<a class="sourceLine" id="cb9-4" title="4">list_chains1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(list_chains, <span class="cf">function</span>(x) x[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mu"</span>,<span class="st">"sigma1"</span>,<span class="st">"error"</span>,</a>
<a class="sourceLine" id="cb9-5" title="5">                                                     <span class="st">"tau"</span>,<span class="st">"total_infections"</span>,</a>
<a class="sourceLine" id="cb9-6" title="6">                                                     <span class="st">"lnlike"</span>,<span class="st">"prior_prob"</span>)])</a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">## Gelman-Rubin diagnostics to assess between-chain convergence for each parameter</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">gelman.diag</span>(<span class="kw">as.mcmc.list</span>(list_chains1)))</a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#&gt; Potential scale reduction factors:</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co">#&gt;                  Point est. Upper C.I.</span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co">#&gt; mu                     1.02       1.03</span></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co">#&gt; sigma1                 1.01       1.03</span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co">#&gt; error                  1.00       1.00</span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="co">#&gt; tau                    1.01       1.02</span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="co">#&gt; total_infections       1.02       1.03</span></a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">#&gt; lnlike                 1.01       1.01</span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">#&gt; prior_prob             1.01       1.01</span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co">#&gt; Multivariate psrf</span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co">#&gt; 1.02</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="kw">gelman.plot</span>(<span class="kw">as.mcmc.list</span>(list_chains1))</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="co">## Effective sample size for each parameter</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">effectiveSize</span>(<span class="kw">as.mcmc.list</span>(list_chains1)))</a>
<a class="sourceLine" id="cb10-4" title="4"><span class="co">#&gt;               mu           sigma1            error              tau </span></a>
<a class="sourceLine" id="cb10-5" title="5"><span class="co">#&gt;         481.6208         727.3621        2435.7809        1171.5251 </span></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co">#&gt; total_infections           lnlike       prior_prob </span></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="co">#&gt;         497.1942         590.3697         607.8823</span></a>
<a class="sourceLine" id="cb10-8" title="8"></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">## Posterior estimates for each parameter</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">as.mcmc.list</span>(list_chains1)))</a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#&gt; Iterations = 1:501</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#&gt; Thinning interval = 1 </span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">#&gt; Number of chains = 5 </span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#&gt; Sample size per chain = 501 </span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#&gt; 1. Empirical mean and standard deviation for each variable,</span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt;    plus standard error of the mean:</span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">#&gt;                        Mean        SD  Naive SE Time-series SE</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co">#&gt; mu                   2.2193 1.475e-01 0.0029480      0.0073858</span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co">#&gt; sigma1               0.1046 4.409e-03 0.0000881      0.0001667</span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="co">#&gt; error                1.1624 3.751e-02 0.0007494      0.0007630</span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="co">#&gt; tau                  0.0306 5.330e-03 0.0001065      0.0001663</span></a>
<a class="sourceLine" id="cb10-25" title="25"><span class="co">#&gt; total_infections  1288.9589 9.359e+01 1.8699544      4.5226816</span></a>
<a class="sourceLine" id="cb10-26" title="26"><span class="co">#&gt; lnlike           -3990.8712 1.532e+02 3.0611018      6.8715326</span></a>
<a class="sourceLine" id="cb10-27" title="27"><span class="co">#&gt; prior_prob       -2081.5167 1.449e+02 2.8955201      6.4436385</span></a>
<a class="sourceLine" id="cb10-28" title="28"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-29" title="29"><span class="co">#&gt; 2. Quantiles for each variable:</span></a>
<a class="sourceLine" id="cb10-30" title="30"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb10-31" title="31"><span class="co">#&gt;                        2.5%        25%        50%        75%      97.5%</span></a>
<a class="sourceLine" id="cb10-32" title="32"><span class="co">#&gt; mu                1.947e+00  2.119e+00  2.221e+00  2.314e+00  2.509e+00</span></a>
<a class="sourceLine" id="cb10-33" title="33"><span class="co">#&gt; sigma1            9.579e-02  1.015e-01  1.048e-01  1.076e-01  1.130e-01</span></a>
<a class="sourceLine" id="cb10-34" title="34"><span class="co">#&gt; error             1.090e+00  1.138e+00  1.162e+00  1.186e+00  1.238e+00</span></a>
<a class="sourceLine" id="cb10-35" title="35"><span class="co">#&gt; tau               2.043e-02  2.692e-02  3.053e-02  3.411e-02  4.144e-02</span></a>
<a class="sourceLine" id="cb10-36" title="36"><span class="co">#&gt; total_infections  1.117e+03  1.226e+03  1.288e+03  1.350e+03  1.476e+03</span></a>
<a class="sourceLine" id="cb10-37" title="37"><span class="co">#&gt; lnlike           -4.291e+03 -4.090e+03 -3.993e+03 -3.887e+03 -3.696e+03</span></a>
<a class="sourceLine" id="cb10-38" title="38"><span class="co">#&gt; prior_prob       -2.364e+03 -2.178e+03 -2.084e+03 -1.982e+03 -1.801e+03</span></a>
<a class="sourceLine" id="cb10-39" title="39"></a>
<a class="sourceLine" id="cb10-40" title="40"></a>
<a class="sourceLine" id="cb10-41" title="41"><span class="co">## Plot the MCMC trace using the `bayesplot` package</span></a>
<a class="sourceLine" id="cb10-42" title="42"><span class="kw">color_scheme_set</span>(<span class="st">"viridis"</span>)</a>
<a class="sourceLine" id="cb10-43" title="43">p_theta_trace &lt;-<span class="st"> </span><span class="kw">mcmc_trace</span>(list_chains1)</a>
<a class="sourceLine" id="cb10-44" title="44"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_theta_trace)</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-6-2.png" width="768"></p>
<p>and at the infection histories:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co">## Extract infection history chain</span></a>
<a class="sourceLine" id="cb11-2" title="2">inf_chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>inf_chain</a>
<a class="sourceLine" id="cb11-3" title="3"></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">## Look at inferred attack rates</span></a>
<a class="sourceLine" id="cb11-5" title="5">p_ar &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_attack_rates.html">plot_attack_rates</a></span>(inf_chain, titre_dat, strain_isolation_times, <span class="dt">pad_chain=</span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb11-6" title="6">                          <span class="dt">plot_den =</span> <span class="ot">TRUE</span>,<span class="dt">prior_pars=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">prior_version=</span>prior_version, </a>
<a class="sourceLine" id="cb11-7" title="7">                                            <span class="dt">alpha=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"alpha"</span>,<span class="st">"values"</span>],</a>
<a class="sourceLine" id="cb11-8" title="8">                                            <span class="dt">beta=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"beta"</span>,<span class="st">"values"</span>])) </a>
<a class="sourceLine" id="cb11-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_ar)</a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#&gt; Warning in regularize.values(x, y, ties, missing(ties)): collapsing to unique</span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#&gt; 'x' values</span></a>
<a class="sourceLine" id="cb11-12" title="12"></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#&gt; Warning in regularize.values(x, y, ties, missing(ties)): collapsing to unique</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#&gt; 'x' values</span></a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">## Calculate convergence diagnostics and summary statistics on infection histories</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co">## Important to scale all infection estimates by number alive from titre_dat</span></a>
<a class="sourceLine" id="cb12-4" title="4">n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive_group.html">get_n_alive_group</a></span>(titre_dat, strain_isolation_times,<span class="dt">melt=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb12-5" title="5"></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">## This function generates a number of MCMC outputs</span></a>
<a class="sourceLine" id="cb12-7" title="7">ps_infhist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_posteriors_infhist.html">plot_posteriors_infhist</a></span>(<span class="dt">inf_chain=</span>inf_chain, </a>
<a class="sourceLine" id="cb12-8" title="8">                                      <span class="dt">years=</span>strain_isolation_times, </a>
<a class="sourceLine" id="cb12-9" title="9">                                      <span class="dt">n_alive=</span>n_alive)</a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#&gt; Padding inf chain...</span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#&gt; Calculating by time summaries...</span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">#&gt; Calculating by individual summaries...</span></a>
<a class="sourceLine" id="cb12-15" title="15"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb12-16" title="16"></a>
<a class="sourceLine" id="cb12-17" title="17"></a>
<a class="sourceLine" id="cb12-18" title="18"><span class="co">## Posterior mean, median, 95% credible intervals and effective sample size</span></a>
<a class="sourceLine" id="cb12-19" title="19"><span class="co">## on per time attack rates</span></a>
<a class="sourceLine" id="cb12-20" title="20"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(ps_infhist[[<span class="st">"estimates"</span>]]<span class="op">$</span>by_year))</a>
<a class="sourceLine" id="cb12-21" title="21"><span class="co">#&gt;       j group      mean     median lower_quantile upper_quantile effective_size</span></a>
<a class="sourceLine" id="cb12-22" title="22"><span class="co">#&gt; 1: 1968     1 0.9358901 0.95238095     0.82142857      1.0000000       597.5393</span></a>
<a class="sourceLine" id="cb12-23" title="23"><span class="co">#&gt; 2: 1969     1 0.2590169 0.06976744     0.00000000      0.9651163       458.7168</span></a>
<a class="sourceLine" id="cb12-24" title="24"><span class="co">#&gt; 3: 1970     1 0.6503526 0.81111111     0.02222222      0.9777778       629.5773</span></a>
<a class="sourceLine" id="cb12-25" title="25"><span class="co">#&gt; 4: 1971     1 0.2597718 0.18478261     0.01086957      0.8478261       971.8555</span></a>
<a class="sourceLine" id="cb12-26" title="26"><span class="co">#&gt; 5: 1972     1 0.1865070 0.14736842     0.01052632      0.5894737      1465.3556</span></a>
<a class="sourceLine" id="cb12-27" title="27"><span class="co">#&gt; 6: 1973     1 0.1419553 0.12371134     0.01030928      0.4020619      1811.9475</span></a>
<a class="sourceLine" id="cb12-28" title="28"><span class="co">#&gt;    gelman_point gelman_upper</span></a>
<a class="sourceLine" id="cb12-29" title="29"><span class="co">#&gt; 1:     1.121062     1.173689</span></a>
<a class="sourceLine" id="cb12-30" title="30"><span class="co">#&gt; 2:     1.013099     1.035579</span></a>
<a class="sourceLine" id="cb12-31" title="31"><span class="co">#&gt; 3:     1.007056     1.021404</span></a>
<a class="sourceLine" id="cb12-32" title="32"><span class="co">#&gt; 4:     1.008536     1.021709</span></a>
<a class="sourceLine" id="cb12-33" title="33"><span class="co">#&gt; 5:     1.004837     1.009290</span></a>
<a class="sourceLine" id="cb12-34" title="34"><span class="co">#&gt; 6:     1.006230     1.015901</span></a>
<a class="sourceLine" id="cb12-35" title="35"></a>
<a class="sourceLine" id="cb12-36" title="36"><span class="co">## Posterior mean, median, 95% credible intervals and effective sample size</span></a>
<a class="sourceLine" id="cb12-37" title="37"><span class="co">## on per individual total number of infections</span></a>
<a class="sourceLine" id="cb12-38" title="38"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(ps_infhist[[<span class="st">"estimates"</span>]]<span class="op">$</span>by_indiv))</a>
<a class="sourceLine" id="cb12-39" title="39"><span class="co">#&gt;    i      mean median lower_quantile upper_quantile effective_size</span></a>
<a class="sourceLine" id="cb12-40" title="40"><span class="co">#&gt; 1: 1 12.360479     12              9             16       1169.470</span></a>
<a class="sourceLine" id="cb12-41" title="41"><span class="co">#&gt; 2: 2  7.790419      8              6             10       1391.668</span></a>
<a class="sourceLine" id="cb12-42" title="42"><span class="co">#&gt; 3: 3  9.282635      9              7             12       1454.059</span></a>
<a class="sourceLine" id="cb12-43" title="43"><span class="co">#&gt; 4: 4  8.488623      8              6             11       1880.095</span></a>
<a class="sourceLine" id="cb12-44" title="44"><span class="co">#&gt; 5: 5  9.657086     10              7             13       1078.471</span></a>
<a class="sourceLine" id="cb12-45" title="45"><span class="co">#&gt; 6: 6  9.235130      9              7             12       1415.614</span></a>
<a class="sourceLine" id="cb12-46" title="46"></a>
<a class="sourceLine" id="cb12-47" title="47"><span class="co">## Check convergence of infection history summary statistics</span></a>
<a class="sourceLine" id="cb12-48" title="48"><span class="co">## MCMC trace plots of attack rates</span></a>
<a class="sourceLine" id="cb12-49" title="49"><span class="co">## Each subplot shows one year</span></a>
<a class="sourceLine" id="cb12-50" title="50"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(ps_infhist[[<span class="st">"by_time_trace"</span>]][[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-2.png" width="672"></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co">## MCMC trace plots of total number of infections per individual</span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="co">## Each subplot shows one individual</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(ps_infhist[[<span class="st">"by_indiv_trace"</span>]][[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-3.png" width="672"></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1"></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co">## Distribution of total number of infections</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(ps_infhist[[<span class="st">"indiv_infections"</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-4.png" width="672"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co">## Check for agreement between inferred cumulative infection histories </span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co">## for some individuals</span></a>
<a class="sourceLine" id="cb15-4" title="4">p_indiv_inf_hists &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_cumulative_inf_plots.html">generate_cumulative_inf_plots</a></span>(inf_chain,<span class="dt">indivs=</span><span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,<span class="dt">pad_chain=</span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb15-5" title="5">                                                  <span class="dt">strain_isolation_times =</span> strain_isolation_times,</a>
<a class="sourceLine" id="cb15-6" title="6">                                                  <span class="dt">number_col=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">## Each subplot shows one individual</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_indiv_inf_hists[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-5.png" width="672"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="co">## Posterior probability that infections occured at given times per individual</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">## Each subplot shows one individual</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_indiv_inf_hists[[<span class="dv">2</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-7-6.png" width="672"></p>
<p>Mixing can sometimes be very poor for per-time attack rates when adjacent times are highly correlated. This is often the case when the amount of data relatively poor. A cruder time resolution (eg. per two years) may be advisable, and mixing may benefit from increasing the <code>proposal_inf_hist_group_swap_ratio</code> and <code>proposal_inf_hist_indiv_prop</code> parameters in the <code>mcmc_pars</code> list in <code>serosolver</code>. <code>proposal_inf_hist_indiv_prop</code> determines how frequently the MCMC sampler uses a proposal step that swaps the a proportion <code>proposal_inf_hist_group_swap_ratio</code> of individual’s infection states between two time points.</p>
<p>Users may also easily check the inferred antibody landscapes at the time each sample was taken. Black dots show observations, shaded regions and black line show 95%, 50% credible intervals and posterior median.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co">## get_titre_predictions expects only a single MCMC chain, so</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="co">## subset for only one chain</span></a>
<a class="sourceLine" id="cb17-3" title="3">chain &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(all_chains<span class="op">$</span>theta_chain)</a>
<a class="sourceLine" id="cb17-4" title="4">chain1 &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb17-5" title="5">inf_chain1 &lt;-<span class="st"> </span>inf_chain[inf_chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,]</a>
<a class="sourceLine" id="cb17-6" title="6"></a>
<a class="sourceLine" id="cb17-7" title="7">titre_preds &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_titre_predictions.html">get_titre_predictions</a></span>(<span class="dt">chain =</span> chain1, </a>
<a class="sourceLine" id="cb17-8" title="8">                                     <span class="dt">infection_histories =</span> inf_chain1, </a>
<a class="sourceLine" id="cb17-9" title="9">                                     <span class="dt">titre_dat =</span> titre_dat, </a>
<a class="sourceLine" id="cb17-10" title="10">                                     <span class="dt">individuals =</span> <span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(titre_dat<span class="op">$</span>individual),</a>
<a class="sourceLine" id="cb17-11" title="11">                                     <span class="dt">antigenic_map =</span> antigenic_map, </a>
<a class="sourceLine" id="cb17-12" title="12">                                     <span class="dt">par_tab =</span> par_tab,<span class="dt">expand_titredat=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">#&gt; Creating model solving function...</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb17-15" title="15">to_use &lt;-<span class="st"> </span>titre_preds<span class="op">$</span>predictions</a>
<a class="sourceLine" id="cb17-16" title="16"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(to_use))</a>
<a class="sourceLine" id="cb17-17" title="17"><span class="co">#&gt;   individual  DOB virus titre samples run group    lower lower_50   median</span></a>
<a class="sourceLine" id="cb17-18" title="18"><span class="co">#&gt; 1          1 1934  1968     4    2009   1     1 3.041685 3.788346 4.280591</span></a>
<a class="sourceLine" id="cb17-19" title="19"><span class="co">#&gt; 2          1 1934  1975     3    2009   1     1 1.902959 2.595233 3.184981</span></a>
<a class="sourceLine" id="cb17-20" title="20"><span class="co">#&gt; 3          1 1934  1979     3    2009   1     1 2.139347 3.222580 3.664448</span></a>
<a class="sourceLine" id="cb17-21" title="21"><span class="co">#&gt; 4          1 1934  1989     4    2009   1     1 2.213891 3.295432 3.932731</span></a>
<a class="sourceLine" id="cb17-22" title="22"><span class="co">#&gt; 5          1 1934  1995     5    2009   1     1 3.638016 4.492440 5.190986</span></a>
<a class="sourceLine" id="cb17-23" title="23"><span class="co">#&gt; 6          1 1934  2002     5    2009   1     1 4.241020 5.049454 5.483356</span></a>
<a class="sourceLine" id="cb17-24" title="24"><span class="co">#&gt;   upper_50    upper      max</span></a>
<a class="sourceLine" id="cb17-25" title="25"><span class="co">#&gt; 1 4.687300 5.598159 3.830762</span></a>
<a class="sourceLine" id="cb17-26" title="26"><span class="co">#&gt; 2 3.745539 4.557163 2.357291</span></a>
<a class="sourceLine" id="cb17-27" title="27"><span class="co">#&gt; 3 4.231587 5.067237 3.223135</span></a>
<a class="sourceLine" id="cb17-28" title="28"><span class="co">#&gt; 4 4.626296 5.620150 3.446563</span></a>
<a class="sourceLine" id="cb17-29" title="29"><span class="co">#&gt; 5 5.635953 6.581105 4.795906</span></a>
<a class="sourceLine" id="cb17-30" title="30"><span class="co">#&gt; 6 5.834227 6.569361 4.615596</span></a>
<a class="sourceLine" id="cb17-31" title="31"></a>
<a class="sourceLine" id="cb17-32" title="32"><span class="co">## Using ggplot</span></a>
<a class="sourceLine" id="cb17-33" title="33"><span class="co">## Shaded regions show 95% and 50% credible intervals, </span></a>
<a class="sourceLine" id="cb17-34" title="34"><span class="co">## line shows posterior median.</span></a>
<a class="sourceLine" id="cb17-35" title="35"><span class="co">## Each suplot shows one individual</span></a>
<a class="sourceLine" id="cb17-36" title="36">titre_pred_p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(to_use[to_use<span class="op">$</span>individual <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,])<span class="op">+</span></a>
<a class="sourceLine" id="cb17-37" title="37"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x=</span>virus,<span class="dt">ymin=</span>lower, <span class="dt">ymax=</span>upper),<span class="dt">fill=</span><span class="st">"gray90"</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb17-38" title="38"><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">x=</span>virus,<span class="dt">ymin=</span>lower_<span class="dv">50</span>, <span class="dt">ymax=</span>upper_<span class="dv">50</span>),<span class="dt">fill=</span><span class="st">"gray70"</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb17-39" title="39"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x=</span>virus, <span class="dt">y=</span>median))<span class="op">+</span></a>
<a class="sourceLine" id="cb17-40" title="40"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x=</span>virus, <span class="dt">y=</span>titre))<span class="op">+</span></a>
<a class="sourceLine" id="cb17-41" title="41"><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">8</span>))<span class="op">+</span></a>
<a class="sourceLine" id="cb17-42" title="42"><span class="st">  </span><span class="kw">ylab</span>(<span class="st">"log titre"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-43" title="43"><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"Time of virus circulation"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-44" title="44"><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-45" title="45"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>individual)</a>
<a class="sourceLine" id="cb17-46" title="46">titre_pred_p</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<div id="further-analyses" class="section level2">
<h2 class="hasAnchor">
<a href="#further-analyses" class="anchor"></a>Further analyses</h2>
<p>Figures in the main text can be readily generated from the MCMC output from above. The source code to generate these figures has been hidden, but can be found in the original .Rmd file for this vignette.</p>
<p>First, we are interested in calculating the number of infections experienced by individuals over time as a function of their age. We see that individuals are infected less frequently as they become older. <img src="cs2_vignette_files/figure-html/age_distribution-1.png" width="576"></p>
<p>Given the sparsity of data here, the default attack rate plot is difficult to interpret. Below is an alternative visualisation of the attack rate, with the 95% and 50% credible intervals shown in red, the posterior median shown in black and the posterior maximum likelihood estimate shown as a dashed green line.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="co">## Find samples that were in both theta and inf hist chains</span></a>
<a class="sourceLine" id="cb18-2" title="2">chain &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(all_chains<span class="op">$</span>theta_chain)</a>
<a class="sourceLine" id="cb18-3" title="3">intersect_samps &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(inf_chain<span class="op">$</span>samp_no), <span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(chain<span class="op">$</span>samp_no))</a>
<a class="sourceLine" id="cb18-4" title="4">chain &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>samp_no <span class="op">%in%</span><span class="st"> </span>intersect_samps,]</a>
<a class="sourceLine" id="cb18-5" title="5"></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="co">## Find the parameter values that gave the highest posterior probability</span></a>
<a class="sourceLine" id="cb18-7" title="7">which_mle &lt;-<span class="st"> </span>chain[<span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span>(chain<span class="op">$</span>lnlike),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>)]</a>
<a class="sourceLine" id="cb18-8" title="8"></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">## Take subset of chain for computational speed, as do not need all samples</span></a>
<a class="sourceLine" id="cb18-10" title="10">samps &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(inf_chain[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>)])</a>
<a class="sourceLine" id="cb18-11" title="11">n_samps &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(samps), <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb18-12" title="12">samps &lt;-<span class="st"> </span>samps[n_samps,]</a>
<a class="sourceLine" id="cb18-13" title="13">samps &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(samps, which_mle) <span class="co">## Plus MLE estimate</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">## Append the MLE estimate, note that this is max(samp_no)</span></a>
<a class="sourceLine" id="cb18-15" title="15"></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">## Create new index variables for simplicity</span></a>
<a class="sourceLine" id="cb18-17" title="17">samps<span class="op">$</span>samp_no1 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(samps)</a>
<a class="sourceLine" id="cb18-18" title="18">samps<span class="op">$</span>chain_no1 &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb18-19" title="19"></a>
<a class="sourceLine" id="cb18-20" title="20"><span class="co">## Inner join to return only our subset of samples</span></a>
<a class="sourceLine" id="cb18-21" title="21"><span class="co">## Reformat samp_no and chain_no identifiers so that code</span></a>
<a class="sourceLine" id="cb18-22" title="22"><span class="co">## sees samples as coming from one chain</span></a>
<a class="sourceLine" id="cb18-23" title="23">inf_chain &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(inf_chain, samps, <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>))</a>
<a class="sourceLine" id="cb18-24" title="24">inf_chain &lt;-<span class="st"> </span>inf_chain[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no1"</span>,<span class="st">"chain_no1"</span>,<span class="st">"i"</span>,<span class="st">"j"</span>,<span class="st">"x"</span>)]</a>
<a class="sourceLine" id="cb18-25" title="25"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(inf_chain)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>)</a>
<a class="sourceLine" id="cb18-26" title="26">inf_chain &lt;-<span class="st"> </span><span class="kw"><a href="../reference/pad_inf_chain.html">pad_inf_chain</a></span>(inf_chain)</a>
<a class="sourceLine" id="cb18-27" title="27"><span class="co">## Rename columns to be more informative</span></a>
<a class="sourceLine" id="cb18-28" title="28"></a>
<a class="sourceLine" id="cb18-29" title="29"><span class="co">## Column names expected by code below</span></a>
<a class="sourceLine" id="cb18-30" title="30"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(inf_chain) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>,<span class="st">"individual"</span>,<span class="st">"year"</span>,<span class="st">"infected"</span>,<span class="st">"group"</span>)</a>
<a class="sourceLine" id="cb18-31" title="31"></a>
<a class="sourceLine" id="cb18-32" title="32"><span class="co">## Data on which strains belong to which cluster</span></a>
<a class="sourceLine" id="cb18-33" title="33">cluster_path &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="st">"fonville_clusters.csv"</span>, <span class="dt">package =</span> <span class="st">"serosolver"</span>)</a>
<a class="sourceLine" id="cb18-34" title="34">clusters &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span>(<span class="dt">file =</span> cluster_path, <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb18-35" title="35">clusters &lt;-<span class="st"> </span>clusters[clusters<span class="op">$</span>year <span class="op">&lt;=</span><span class="st"> </span>sample_year,]</a>
<a class="sourceLine" id="cb18-36" title="36"></a>
<a class="sourceLine" id="cb18-37" title="37"><span class="co">## j=1 corresponds to the year 1968</span></a>
<a class="sourceLine" id="cb18-38" title="38">inf_chain<span class="op">$</span>year &lt;-<span class="st"> </span>inf_chain<span class="op">$</span>year <span class="op">+</span><span class="st"> </span><span class="dv">1967</span></a>
<a class="sourceLine" id="cb18-39" title="39"></a>
<a class="sourceLine" id="cb18-40" title="40"><span class="co">## Merge cluster data and infection history data</span></a>
<a class="sourceLine" id="cb18-41" title="41">inf_chain &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(inf_chain, clusters[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>,<span class="st">"cluster1"</span>)],<span class="dt">by=</span><span class="st">"year"</span>)</a>
<a class="sourceLine" id="cb18-42" title="42"></a>
<a class="sourceLine" id="cb18-43" title="43"><span class="co">## Calculate ages and age groups of all individuals</span></a>
<a class="sourceLine" id="cb18-44" title="44">titre_dat<span class="op">$</span>age &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(strain_isolation_times) <span class="op">-</span><span class="st"> </span>titre_dat<span class="op">$</span>DOB</a>
<a class="sourceLine" id="cb18-45" title="45">titre_dat<span class="op">$</span>age_group &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cut.html">cut</a></span>(titre_dat<span class="op">$</span>age,<span class="dt">breaks=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">0</span>,<span class="dv">20</span>,<span class="dv">100</span>),<span class="dt">include.lowest=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb18-46" title="46">ages &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(titre_dat[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"individual"</span>,<span class="st">"age_group"</span>,<span class="st">"DOB"</span>,<span class="st">"age"</span>)])</a>
<a class="sourceLine" id="cb18-47" title="47"></a>
<a class="sourceLine" id="cb18-48" title="48"><span class="co">## Merge infection histories with individual data</span></a>
<a class="sourceLine" id="cb18-49" title="49">inf_chain&lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(inf_chain, <span class="kw">data.table</span>(ages), <span class="dt">by=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"individual"</span>))</a>
<a class="sourceLine" id="cb18-50" title="50"></a>
<a class="sourceLine" id="cb18-51" title="51"><span class="co">## Alive status for each individual for each time,</span></a>
<a class="sourceLine" id="cb18-52" title="52"><span class="co">## only interested in individuals that were alive </span></a>
<a class="sourceLine" id="cb18-53" title="53"><span class="co">## when a virus circulated</span></a>
<a class="sourceLine" id="cb18-54" title="54">inf_chain<span class="op">$</span>alive &lt;-<span class="st"> </span>inf_chain<span class="op">$</span>DOB <span class="op">&lt;=</span><span class="st"> </span>inf_chain<span class="op">$</span>year</a>
<a class="sourceLine" id="cb18-55" title="55">inf_chain &lt;-<span class="st"> </span>inf_chain[inf_chain<span class="op">$</span>alive,]</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/attack_rate_plot-1.png" width="768"></p>
<p>Finally, inferring individual infection histories allows us to investigate age-specific patterns of incidence. Here, we show the proportion of individuals that were infected at least once within a single antigenic cluster, finding that clusters that circulate for longer tend to infect a far higher proportion of the population. Furthermore, we see that a far higher proportion of the younger age group is infected in more recent years. <img src="cs2_vignette_files/figure-html/age_clusters_plot-1.png" width="480"></p>
</div>
</div>
<div id="simulation-recovery" class="section level1">
<h1 class="hasAnchor">
<a href="#simulation-recovery" class="anchor"></a>Simulation recovery</h1>
<p>We finish the vignette by presenting a simulation-recovery experiment to test the ability of the framework to recover known infection histories and antibody kinetics parameters using simulated data that matches the real dataset.</p>
<div id="extract-mle-parameters-from-fits" class="section level2">
<h2 class="hasAnchor">
<a href="#extract-mle-parameters-from-fits" class="anchor"></a>Extract MLE parameters from fits</h2>
<p>We simulate infection histories and antibody titre data based on the “real” parameters inferred from fitting the model above. First, we extract the maximum posterior probability antibody kinetics parameters and attack rates.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co">## Read in MCMC chains from fitting</span></a>
<a class="sourceLine" id="cb19-2" title="2">all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_real,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,</a>
<a class="sourceLine" id="cb19-3" title="3">                               <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="co">#&gt; Chains detected: </span></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_1_infection_histories.csv</span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_2_infection_histories.csv</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_3_infection_histories.csv</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_4_infection_histories.csv</span></a>
<a class="sourceLine" id="cb19-10" title="10"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_real//case_study_2_5_infection_histories.csv</span></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="co">#&gt; [1] 643851</span></a>
<a class="sourceLine" id="cb19-13" title="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb19-15" title="15"><span class="co">#&gt; [1] 650759</span></a>
<a class="sourceLine" id="cb19-16" title="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb19-17" title="17"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb19-18" title="18"><span class="co">#&gt; [1] 640438</span></a>
<a class="sourceLine" id="cb19-19" title="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb19-20" title="20"><span class="co">#&gt; [[4]]</span></a>
<a class="sourceLine" id="cb19-21" title="21"><span class="co">#&gt; [1] 645224</span></a>
<a class="sourceLine" id="cb19-22" title="22"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb19-23" title="23"><span class="co">#&gt; [[5]]</span></a>
<a class="sourceLine" id="cb19-24" title="24"><span class="co">#&gt; [1] 648570</span></a>
<a class="sourceLine" id="cb19-25" title="25"></a>
<a class="sourceLine" id="cb19-26" title="26"><span class="co">## Alternative, load the included MCMC chains rather than re-running</span></a>
<a class="sourceLine" id="cb19-27" title="27"><span class="co">## data(cs2_chains_real_b)</span></a>
<a class="sourceLine" id="cb19-28" title="28"><span class="co">## all_chains &lt;- cs2_chains_real_b</span></a>
<a class="sourceLine" id="cb19-29" title="29"></a>
<a class="sourceLine" id="cb19-30" title="30"><span class="co">## Find samples that were in both theta and inf hist chains</span></a>
<a class="sourceLine" id="cb19-31" title="31">chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>theta_chain</a>
<a class="sourceLine" id="cb19-32" title="32">inf_chain &lt;-<span class="st"> </span>all_chains<span class="op">$</span>inf_chain</a>
<a class="sourceLine" id="cb19-33" title="33">intersect_samps &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(inf_chain<span class="op">$</span>samp_no), <span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(chain<span class="op">$</span>samp_no))</a>
<a class="sourceLine" id="cb19-34" title="34">chain &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>samp_no <span class="op">%in%</span><span class="st"> </span>intersect_samps,]</a>
<a class="sourceLine" id="cb19-35" title="35"></a>
<a class="sourceLine" id="cb19-36" title="36"><span class="co">## Find the parameter values that gave the highest posterior probability</span></a>
<a class="sourceLine" id="cb19-37" title="37">which_mle &lt;-<span class="st"> </span>chain[<span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span>(chain<span class="op">$</span>lnlike),<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>)]</a>
<a class="sourceLine" id="cb19-38" title="38">mle_theta_pars &lt;-<span class="st"> </span>chain[chain<span class="op">$</span>samp_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>samp_no <span class="op">&amp;</span><span class="st"> </span>chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>chain_no,]</a>
<a class="sourceLine" id="cb19-39" title="39"></a>
<a class="sourceLine" id="cb19-40" title="40"><span class="co">## Store total infections to compare later</span></a>
<a class="sourceLine" id="cb19-41" title="41">mle_total_infs &lt;-<span class="st"> </span>mle_theta_pars[,<span class="st">"total_infections"</span>]</a>
<a class="sourceLine" id="cb19-42" title="42">mle_theta_pars &lt;-<span class="st"> </span>mle_theta_pars[,par_tab<span class="op">$</span>names]</a>
<a class="sourceLine" id="cb19-43" title="43">mle_inf_hist &lt;-<span class="st"> </span>inf_chain[inf_chain<span class="op">$</span>samp_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>samp_no <span class="op">&amp;</span><span class="st"> </span>inf_chain<span class="op">$</span>chain_no <span class="op">==</span><span class="st"> </span>which_mle<span class="op">$</span>chain_no,]</a>
<a class="sourceLine" id="cb19-44" title="44"></a>
<a class="sourceLine" id="cb19-45" title="45"><span class="co">## Generate full infection history matrix using provided function</span></a>
<a class="sourceLine" id="cb19-46" title="46">mle_inf_hist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_summary_inf_chain.html">expand_summary_inf_chain</a></span>(mle_inf_hist[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"j"</span>,<span class="st">"i"</span>,<span class="st">"x"</span>)])</a>
<a class="sourceLine" id="cb19-47" title="47"><span class="co">## Find number of infections per year from this infection history</span></a>
<a class="sourceLine" id="cb19-48" title="48">no_infs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span>(mle_inf_hist[,<span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(mle_inf_hist)])</a>
<a class="sourceLine" id="cb19-49" title="49"></a>
<a class="sourceLine" id="cb19-50" title="50"><span class="co">## If missing time points in simulated attack rates</span></a>
<a class="sourceLine" id="cb19-51" title="51"><span class="cf">if</span>(<span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(no_infs) <span class="op">&lt;</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(strain_isolation_times)){</a>
<a class="sourceLine" id="cb19-52" title="52">  diff_lengths &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(strain_isolation_times) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(no_infs)</a>
<a class="sourceLine" id="cb19-53" title="53">  no_infs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(no_infs, <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="dv">0</span>, diff_lengths))</a>
<a class="sourceLine" id="cb19-54" title="54">}</a>
<a class="sourceLine" id="cb19-55" title="55"></a>
<a class="sourceLine" id="cb19-56" title="56"><span class="co">## Find attack rate per year</span></a>
<a class="sourceLine" id="cb19-57" title="57">n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive.html">get_n_alive</a></span>(titre_dat, strain_isolation_times)</a>
<a class="sourceLine" id="cb19-58" title="58">attack_rates &lt;-<span class="st"> </span>no_infs<span class="op">/</span>n_alive</a></code></pre></div>
<p>Functions are provided to simulate antibody titre data under a given serosurvey design. The antibody kinetics parameters and attack rates estimated above are used to simulate titres from the model. The <code>simulate_data</code> function is well documented, and users should refer to the help file to customise the simulated serosurvey design.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1234</span>)</a>
<a class="sourceLine" id="cb20-2" title="2"></a>
<a class="sourceLine" id="cb20-3" title="3">sim_par_tab &lt;-<span class="st"> </span>par_tab</a>
<a class="sourceLine" id="cb20-4" title="4">sim_par_tab<span class="op">$</span>values &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(mle_theta_pars)</a>
<a class="sourceLine" id="cb20-5" title="5">sim_par_tab[sim_par_tab<span class="op">$</span>names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>),<span class="st">"values"</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb20-6" title="6"></a>
<a class="sourceLine" id="cb20-7" title="7">age_min &lt;-<span class="st"> </span><span class="dv">2009</span> <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(titre_dat<span class="op">$</span>DOB)</a>
<a class="sourceLine" id="cb20-8" title="8">age_max &lt;-<span class="st"> </span><span class="dv">2009</span> <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(titre_dat<span class="op">$</span>DOB)</a>
<a class="sourceLine" id="cb20-9" title="9">n_indiv &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(titre_dat<span class="op">$</span>individual))</a>
<a class="sourceLine" id="cb20-10" title="10">dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simulate_data.html">simulate_data</a></span>(<span class="dt">par_tab=</span>sim_par_tab,</a>
<a class="sourceLine" id="cb20-11" title="11">                     <span class="dt">n_indiv=</span>n_indiv, </a>
<a class="sourceLine" id="cb20-12" title="12">                     <span class="dt">buckets=</span>resolution, </a>
<a class="sourceLine" id="cb20-13" title="13">                     <span class="dt">strain_isolation_times=</span>strain_isolation_times,</a>
<a class="sourceLine" id="cb20-14" title="14">                     <span class="dt">sampling_times=</span><span class="dv">2009</span>, </a>
<a class="sourceLine" id="cb20-15" title="15">                     <span class="dt">nsamps=</span><span class="dv">1</span>, </a>
<a class="sourceLine" id="cb20-16" title="16">                     <span class="dt">antigenic_map=</span>antigenic_map, </a>
<a class="sourceLine" id="cb20-17" title="17">                     <span class="dt">age_min=</span>age_min,</a>
<a class="sourceLine" id="cb20-18" title="18">                     <span class="dt">age_max=</span>age_max,</a>
<a class="sourceLine" id="cb20-19" title="19">                     <span class="dt">attack_rates=</span>attack_rates,</a>
<a class="sourceLine" id="cb20-20" title="20">                     <span class="dt">repeats=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb20-21" title="21"><span class="co">#&gt; Simulating data</span></a>
<a class="sourceLine" id="cb20-22" title="22"></a>
<a class="sourceLine" id="cb20-23" title="23"></a>
<a class="sourceLine" id="cb20-24" title="24"><span class="co">## Inspect simulated antibody titre data and infection histories</span></a>
<a class="sourceLine" id="cb20-25" title="25">sim_titre_dat &lt;-<span class="st"> </span>dat[[<span class="st">"data"</span>]]</a>
<a class="sourceLine" id="cb20-26" title="26">sim_infection_histories &lt;-<span class="st"> </span>dat[[<span class="st">"infection_histories"</span>]]</a>
<a class="sourceLine" id="cb20-27" title="27"></a>
<a class="sourceLine" id="cb20-28" title="28"><span class="co">## Store total infections to compare later</span></a>
<a class="sourceLine" id="cb20-29" title="29">actual_total_infections &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(sim_infection_histories)</a>
<a class="sourceLine" id="cb20-30" title="30"></a>
<a class="sourceLine" id="cb20-31" title="31"><span class="kw"><a href="../reference/plot_data.html">plot_data</a></span>(sim_titre_dat, sim_infection_histories, </a>
<a class="sourceLine" id="cb20-32" title="32">          strain_isolation_times,<span class="dt">n_indivs =</span> <span class="dv">5</span>)</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">## Use titres only against same viruses tested in real data</span></a>
<a class="sourceLine" id="cb21-3" title="3">viruses &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(titre_dat<span class="op">$</span>virus)</a>
<a class="sourceLine" id="cb21-4" title="4">sim_titre_dat &lt;-<span class="st"> </span>sim_titre_dat[sim_titre_dat<span class="op">$</span>virus <span class="op">%in%</span><span class="st"> </span>viruses, ]</a>
<a class="sourceLine" id="cb21-5" title="5">sim_ages &lt;-<span class="st"> </span>dat[[<span class="st">"ages"</span>]]</a>
<a class="sourceLine" id="cb21-6" title="6">sim_titre_dat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(sim_titre_dat, sim_ages)</a>
<a class="sourceLine" id="cb21-7" title="7">sim_ar &lt;-<span class="st"> </span>dat[[<span class="st">"attack_rates"</span>]]</a></code></pre></div>
</div>
<div id="simulation-fitting" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-fitting" class="anchor"></a>Simulation fitting</h2>
<p>Once these simulated data have been generated, the work flow becomes exactly the same as with the real data above.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">filename &lt;-<span class="st"> "case_study_2_sim"</span></a>
<a class="sourceLine" id="cb22-2" title="2"></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co">## Distinct filename for each chain</span></a>
<a class="sourceLine" id="cb22-4" title="4">no_chains &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb22-5" title="5">filenames &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(filename, <span class="st">"_"</span>,<span class="dv">1</span><span class="op">:</span>no_chains)</a>
<a class="sourceLine" id="cb22-6" title="6"></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co">## Create the posterior solving function that will be used in the MCMC framework </span></a>
<a class="sourceLine" id="cb22-8" title="8">model_func &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_posterior_func.html">create_posterior_func</a></span>(<span class="dt">par_tab=</span>sim_par_tab,</a>
<a class="sourceLine" id="cb22-9" title="9">                                <span class="dt">titre_dat=</span>sim_titre_dat,</a>
<a class="sourceLine" id="cb22-10" title="10">                                <span class="dt">antigenic_map=</span>antigenic_map,</a>
<a class="sourceLine" id="cb22-11" title="11">                                <span class="dt">version=</span>prior_version) <span class="co"># function in posteriors.R</span></a>
<a class="sourceLine" id="cb22-12" title="12"><span class="co">#&gt; Creating posterior solving function...</span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="co">#&gt; </span></a></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co">## Generate results in parallel</span></a>
<a class="sourceLine" id="cb23-2" title="2">res &lt;-<span class="st"> </span><span class="kw">foreach</span>(<span class="dt">x =</span> filenames, <span class="dt">.packages =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'serosolver'</span>,<span class="st">'data.table'</span>,<span class="st">'plyr'</span>)) <span class="op">%dopar%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb23-3" title="3">  <span class="co">## Not all random starting conditions return finite likelihood, so for each chain generate random</span></a>
<a class="sourceLine" id="cb23-4" title="4">  <span class="co">## conditions until we get one with a finite likelihood</span></a>
<a class="sourceLine" id="cb23-5" title="5">  start_prob &lt;-<span class="st"> </span><span class="op">-</span><span class="ot">Inf</span></a>
<a class="sourceLine" id="cb23-6" title="6">  <span class="cf">while</span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/is.finite.html">is.finite</a></span>(start_prob)){</a>
<a class="sourceLine" id="cb23-7" title="7">    <span class="co">## Generate starting values for theta</span></a>
<a class="sourceLine" id="cb23-8" title="8">    start_tab &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_start_tab.html">generate_start_tab</a></span>(par_tab)</a>
<a class="sourceLine" id="cb23-9" title="9">    <span class="co">## Generate starting infection history</span></a>
<a class="sourceLine" id="cb23-10" title="10">    start_inf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setup_infection_histories_titre.html">setup_infection_histories_titre</a></span>(sim_titre_dat, strain_isolation_times, </a>
<a class="sourceLine" id="cb23-11" title="11">                                                 <span class="dt">space=</span><span class="dv">3</span>,<span class="dt">titre_cutoff=</span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb23-12" title="12">    start_prob &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">model_func</span>(start_tab<span class="op">$</span>values, start_inf)[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb23-13" title="13">  }</a>
<a class="sourceLine" id="cb23-14" title="14">  </a>
<a class="sourceLine" id="cb23-15" title="15">  res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/serosolver.html">serosolver</a></span>(<span class="dt">par_tab =</span> start_tab, </a>
<a class="sourceLine" id="cb23-16" title="16">                  <span class="dt">titre_dat =</span> sim_titre_dat,</a>
<a class="sourceLine" id="cb23-17" title="17">                  <span class="dt">antigenic_map =</span> antigenic_map,</a>
<a class="sourceLine" id="cb23-18" title="18">                  <span class="dt">start_inf_hist =</span> start_inf, </a>
<a class="sourceLine" id="cb23-19" title="19">                  <span class="dt">mcmc_pars =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iterations"</span>=<span class="dv">500000</span>,<span class="st">"adaptive_iterations"</span>=<span class="dv">100000</span>,<span class="st">"thin"</span>=<span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb23-20" title="20">                                <span class="st">"thin_inf_hist"</span>=<span class="dv">1000</span>,<span class="st">"save_block"</span>=<span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb23-21" title="21">                                <span class="st">"proposal_inf_hist_group_swap_ratio"</span>=<span class="fl">0.8</span>, <span class="st">"proposal_inf_hist_indiv_prop"</span>=<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb23-22" title="22">                  <span class="dt">filename =</span> <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(chain_path_sim,x), </a>
<a class="sourceLine" id="cb23-23" title="23">                  <span class="dt">CREATE_POSTERIOR_FUNC =</span> create_posterior_func, </a>
<a class="sourceLine" id="cb23-24" title="24">                  <span class="dt">version =</span> prior_version)</a>
<a class="sourceLine" id="cb23-25" title="25">}</a></code></pre></div>
</div>
<div id="simulation-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#simulation-analysis" class="anchor"></a>Simulation analysis</h2>
<p>MCMC chains should be checked for convergence under the usual diagnostics. We also compare the inferred posterior distributions to the known true parameter values. We see that convergence and between-chain agreement is good and that the model recovers reasonably unbiased estimates for some parameters. However, under this sampling strategy the model slightly underestimates the amount of long term antibody boosting elicited by a single infection and overestimates the total number of infections. This is driven by the contribution of the attack rate prior relative to the contribution of the likelihood (the data). Increasing the number of measured titres (for example, measure titres against 40 viruses rather than 9) or using a more informative attack rate prior would help reduce this bias.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="co">## Read in the MCMC chains</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="co">## Note that `thin` here is in addition to any thinning done during the fitting</span></a>
<a class="sourceLine" id="cb24-3" title="3">sim_all_chains &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_mcmc_chains.html">load_mcmc_chains</a></span>(<span class="dt">location=</span>chain_path_sim,<span class="dt">thin=</span><span class="dv">1</span>,<span class="dt">burnin=</span><span class="dv">100000</span>,</a>
<a class="sourceLine" id="cb24-4" title="4">                               <span class="dt">par_tab=</span>par_tab,<span class="dt">unfixed=</span><span class="ot">FALSE</span>,<span class="dt">convert_mcmc=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co">#&gt; Chains detected:     5Highest MCMC sample interations: </span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="co">#&gt; Chains detected: </span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_sim//case_study_2_sim_1_infection_histories.csv</span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_sim//case_study_2_sim_2_infection_histories.csv</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_sim//case_study_2_sim_3_infection_histories.csv</span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_sim//case_study_2_sim_4_infection_histories.csv</span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="co">#&gt; X:/Program Files/R/R-3.6.2/library/serosolver/extdata/cs2_sim//case_study_2_sim_5_infection_histories.csv</span></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co">#&gt; [1] 641001</span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-15" title="15"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb24-16" title="16"><span class="co">#&gt; [1] 645313</span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-18" title="18"><span class="co">#&gt; [[3]]</span></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co">#&gt; [1] 647117</span></a>
<a class="sourceLine" id="cb24-20" title="20"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-21" title="21"><span class="co">#&gt; [[4]]</span></a>
<a class="sourceLine" id="cb24-22" title="22"><span class="co">#&gt; [1] 639237</span></a>
<a class="sourceLine" id="cb24-23" title="23"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-24" title="24"><span class="co">#&gt; [[5]]</span></a>
<a class="sourceLine" id="cb24-25" title="25"><span class="co">#&gt; [1] 640481</span></a>
<a class="sourceLine" id="cb24-26" title="26"></a>
<a class="sourceLine" id="cb24-27" title="27"><span class="co">## Alternative, load the included MCMC chains rather than re-running</span></a>
<a class="sourceLine" id="cb24-28" title="28"><span class="co">## data(cs2_chains_sim)</span></a>
<a class="sourceLine" id="cb24-29" title="29"><span class="co">## sim_all_chains &lt;- cs2_chains_sim</span></a>
<a class="sourceLine" id="cb24-30" title="30"></a>
<a class="sourceLine" id="cb24-31" title="31">theta_chain &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>theta_chain</a>
<a class="sourceLine" id="cb24-32" title="32"><span class="co">## Get the MCMC chains as a list</span></a>
<a class="sourceLine" id="cb24-33" title="33">list_chains &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>theta_list_chains</a>
<a class="sourceLine" id="cb24-34" title="34"><span class="co">## Look at diagnostics for the free parameters</span></a>
<a class="sourceLine" id="cb24-35" title="35">list_chains1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(list_chains, <span class="cf">function</span>(x) x[,<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mu"</span>,<span class="st">"sigma1"</span>,<span class="st">"error"</span>,</a>
<a class="sourceLine" id="cb24-36" title="36">                                                     <span class="st">"tau"</span>,<span class="st">"total_infections"</span>,</a>
<a class="sourceLine" id="cb24-37" title="37">                                                     <span class="st">"lnlike"</span>,<span class="st">"prior_prob"</span>)])</a>
<a class="sourceLine" id="cb24-38" title="38"></a>
<a class="sourceLine" id="cb24-39" title="39"><span class="co">## Gelman-Rubin diagnostics and effective sample size</span></a>
<a class="sourceLine" id="cb24-40" title="40"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">gelman.diag</span>(<span class="kw">as.mcmc.list</span>(list_chains1)))</a>
<a class="sourceLine" id="cb24-41" title="41"><span class="co">#&gt; Potential scale reduction factors:</span></a>
<a class="sourceLine" id="cb24-42" title="42"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-43" title="43"><span class="co">#&gt;                  Point est. Upper C.I.</span></a>
<a class="sourceLine" id="cb24-44" title="44"><span class="co">#&gt; mu                     1.01       1.02</span></a>
<a class="sourceLine" id="cb24-45" title="45"><span class="co">#&gt; sigma1                 1.00       1.00</span></a>
<a class="sourceLine" id="cb24-46" title="46"><span class="co">#&gt; error                  1.00       1.00</span></a>
<a class="sourceLine" id="cb24-47" title="47"><span class="co">#&gt; tau                    1.00       1.00</span></a>
<a class="sourceLine" id="cb24-48" title="48"><span class="co">#&gt; total_infections       1.02       1.06</span></a>
<a class="sourceLine" id="cb24-49" title="49"><span class="co">#&gt; lnlike                 1.01       1.04</span></a>
<a class="sourceLine" id="cb24-50" title="50"><span class="co">#&gt; prior_prob             1.01       1.04</span></a>
<a class="sourceLine" id="cb24-51" title="51"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-52" title="52"><span class="co">#&gt; Multivariate psrf</span></a>
<a class="sourceLine" id="cb24-53" title="53"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb24-54" title="54"><span class="co">#&gt; 1.03</span></a>
<a class="sourceLine" id="cb24-55" title="55"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">effectiveSize</span>(<span class="kw">as.mcmc.list</span>(list_chains1)))</a>
<a class="sourceLine" id="cb24-56" title="56"><span class="co">#&gt;               mu           sigma1            error              tau </span></a>
<a class="sourceLine" id="cb24-57" title="57"><span class="co">#&gt;         815.2872        1413.2702        2555.2807        1102.1962 </span></a>
<a class="sourceLine" id="cb24-58" title="58"><span class="co">#&gt; total_infections           lnlike       prior_prob </span></a>
<a class="sourceLine" id="cb24-59" title="59"><span class="co">#&gt;         658.8086         844.4075         779.8205</span></a>
<a class="sourceLine" id="cb24-60" title="60"></a>
<a class="sourceLine" id="cb24-61" title="61">melted_theta_chain &lt;-<span class="st"> </span>reshape2<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(theta_chain), <span class="dt">id.vars=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"samp_no"</span>,<span class="st">"chain_no"</span>))</a>
<a class="sourceLine" id="cb24-62" title="62">estimated_pars &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(sim_par_tab[sim_par_tab<span class="op">$</span>fixed <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,<span class="st">"names"</span>],<span class="st">"total_infections"</span>)</a>
<a class="sourceLine" id="cb24-63" title="63">melted_theta_chain &lt;-<span class="st"> </span>melted_theta_chain[melted_theta_chain<span class="op">$</span>variable <span class="op">%in%</span><span class="st"> </span>estimated_pars,]</a>
<a class="sourceLine" id="cb24-64" title="64"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(melted_theta_chain)[<span class="dv">3</span>] &lt;-<span class="st"> "names"</span></a>
<a class="sourceLine" id="cb24-65" title="65"></a>
<a class="sourceLine" id="cb24-66" title="66">add_row &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="st">"total_infections"</span>,actual_total_infections,<span class="dv">0</span>,<span class="fl">0.1</span>,<span class="dv">0</span>,<span class="dv">10000</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb24-67" title="67"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(add_row) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(sim_par_tab)</a>
<a class="sourceLine" id="cb24-68" title="68">sim_par_tab1 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(sim_par_tab, add_row)</a>
<a class="sourceLine" id="cb24-69" title="69"></a>
<a class="sourceLine" id="cb24-70" title="70"><span class="kw">ggplot</span>(melted_theta_chain) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-71" title="71"><span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x=</span>value,<span class="dt">fill=</span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(chain_no)),<span class="dt">alpha=</span><span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-72" title="72"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">data=</span>sim_par_tab1[sim_par_tab1<span class="op">$</span>fixed <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,],<span class="kw">aes</span>(<span class="dt">xintercept=</span>values),<span class="dt">linetype=</span><span class="st">"dashed"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-73" title="73"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>names,<span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-74" title="74"><span class="st">  </span><span class="kw">theme_classic</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-75" title="75"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"bottom"</span>)</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>Recovery of known attack rates is also reasonably accurate, though the constraint of the posterior distibution is quite low for many years where identifiability is poor. Again, more titre data or more individuals would improve inferential power. One particularly reassuring plot is the comparison of known individual cumulative infection histories (the cumulative sum of infections over time for an individual) against the estimated posterior distribution of cumulative infection histories. We see that the 95% credible intervals capture the true cumulative infection histories in almost all cases.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="co">## Extract infection history chain</span></a>
<a class="sourceLine" id="cb25-2" title="2">inf_chain &lt;-<span class="st"> </span>sim_all_chains<span class="op">$</span>inf_chain</a>
<a class="sourceLine" id="cb25-3" title="3"></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="co">## Look at inferred attack rates</span></a>
<a class="sourceLine" id="cb25-5" title="5">p_ar &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_attack_rates.html">plot_attack_rates</a></span>(inf_chain, sim_titre_dat, strain_isolation_times, <span class="dt">pad_chain=</span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb25-6" title="6">                            <span class="dt">plot_den =</span> <span class="ot">TRUE</span>,<span class="dt">prior_pars=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">prior_version=</span>prior_version, </a>
<a class="sourceLine" id="cb25-7" title="7">                                                          <span class="dt">alpha=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"alpha"</span>,<span class="st">"values"</span>],</a>
<a class="sourceLine" id="cb25-8" title="8">                                                          <span class="dt">beta=</span>par_tab[par_tab<span class="op">$</span>names<span class="op">==</span><span class="st">"beta"</span>,<span class="st">"values"</span>]))  <span class="op">+</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data=</span>sim_ar,<span class="kw">aes</span>(<span class="dt">x=</span>year,<span class="dt">y=</span>AR),<span class="dt">col=</span><span class="st">"purple"</span>)</a>
<a class="sourceLine" id="cb25-10" title="10"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_ar)</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="co">## Calculate convergence diagnostics and summary statistics on infection histories</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="co">## Important to scale all infection estimates by number alive from titre_dat</span></a>
<a class="sourceLine" id="cb26-4" title="4">sim_n_alive &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_n_alive_group.html">get_n_alive_group</a></span>(sim_titre_dat, strain_isolation_times,<span class="dt">melt=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb26-5" title="5"></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="co">## This function generates a number of MCMC outputs</span></a>
<a class="sourceLine" id="cb26-7" title="7">ps_infhist &lt;-<span class="st"> </span><span class="kw"><a href="../reference/plot_posteriors_infhist.html">plot_posteriors_infhist</a></span>(<span class="dt">inf_chain=</span>inf_chain, </a>
<a class="sourceLine" id="cb26-8" title="8">                                      <span class="dt">years=</span>strain_isolation_times, </a>
<a class="sourceLine" id="cb26-9" title="9">                                      <span class="dt">n_alive=</span>sim_n_alive)</a>
<a class="sourceLine" id="cb26-10" title="10"><span class="co">#&gt; Padding inf chain...</span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="co">#&gt; Calculating by time summaries...</span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb26-14" title="14"><span class="co">#&gt; Calculating by individual summaries...</span></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co">#&gt; Done</span></a>
<a class="sourceLine" id="cb26-16" title="16"></a>
<a class="sourceLine" id="cb26-17" title="17"><span class="co">## Check convergence of infection history summary statistics</span></a>
<a class="sourceLine" id="cb26-18" title="18"><span class="co">## MCMC trace plots of attack rates</span></a>
<a class="sourceLine" id="cb26-19" title="19"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(ps_infhist[[<span class="st">"by_time_trace"</span>]][[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-12-2.png" width="768"></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="co">## MCMC trace plots of total number of infections per individual</span></a>
<a class="sourceLine" id="cb27-2" title="2"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(ps_infhist[[<span class="st">"by_indiv_trace"</span>]][[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-12-3.png" width="768"></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="co">## Check for agreement between inferred cumulative infection histories </span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="co">## for some individuals</span></a>
<a class="sourceLine" id="cb28-4" title="4">p_indiv_inf_hists &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generate_cumulative_inf_plots.html">generate_cumulative_inf_plots</a></span>(inf_chain,<span class="dt">indivs=</span><span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,<span class="dt">pad_chain=</span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb28-5" title="5">                                                   <span class="dt">real_inf_hist=</span>sim_infection_histories,</a>
<a class="sourceLine" id="cb28-6" title="6">                                                  <span class="dt">strain_isolation_times =</span> strain_isolation_times,</a>
<a class="sourceLine" id="cb28-7" title="7">                                                  <span class="dt">number_col=</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb28-8" title="8"><span class="co">## Each subplot shows one individual</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_indiv_inf_hists[[<span class="dv">1</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-12-4.png" width="768"></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="co">## Posterior probability that infections occured at given times per individual</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="co">## Each subplot shows one individual</span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(p_indiv_inf_hists[[<span class="dv">2</span>]])</a></code></pre></div>
<p><img src="cs2_vignette_files/figure-html/unnamed-chunk-12-5.png" width="768"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li>
<a href="#setup">Setup</a><ul class="nav nav-pills nav-stacked">
<li><a href="#installation-and-requirements">Installation and requirements</a></li>
      <li><a href="#assumptions">Assumptions</a></li>
      <li><a href="#preparing-the-data">Preparing the data</a></li>
      <li><a href="#summary">Summary</a></li>
      </ul>
</li>
      <li><a href="#running-the-mcmc">Running the MCMC</a></li>
      <li>
<a href="#post-run-analyses">Post-run analyses</a><ul class="nav nav-pills nav-stacked">
<li><a href="#further-analyses">Further analyses</a></li>
      </ul>
</li>
      <li>
<a href="#simulation-recovery">Simulation recovery</a><ul class="nav nav-pills nav-stacked">
<li><a href="#extract-mle-parameters-from-fits">Extract MLE parameters from fits</a></li>
      <li><a href="#simulation-fitting">Simulation fitting</a></li>
      <li><a href="#simulation-analysis">Simulation analysis</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Hay, Adam Kucharski, Kylie Ainslie, Amanda Minter, Steven Riley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
